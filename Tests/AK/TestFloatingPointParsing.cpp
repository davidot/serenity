/*
 * Copyright (c) 2020, the SerenityOS developers.
 *
 * SPDX-License-Identifier: BSD-2-Clause
 */

#include <LibTest/TestCase.h>

#include <AK/FloatingPointStringConversions.h>
#include <AK/JsonParser.h>
#include <stdlib.h>

[[maybe_unused]] static double strtod_wrapper(StringView view)
{
    VERIFY(!view.is_empty());
    char* end = const_cast<char*>(view.characters_without_null_termination() + view.length());
    return strtod(view.characters_without_null_termination(), &end);
}

[[maybe_unused]] static float strtof_wrapper(StringView view)
{
    VERIFY(!view.is_empty());
    char* end = const_cast<char*>(view.characters_without_null_termination() + view.length());
    return strtof(view.characters_without_null_termination(), &end);
}

[[maybe_unused]] static double json_parse_wrapper(StringView view)
{
    VERIFY(!view.is_empty());
    JsonParser parser { view };
    auto error_or_result = parser.parse();
    if (error_or_result.is_error() || !error_or_result.value().is_double())
        return __builtin_nan("");
    return strtod_wrapper(view);
}

[[maybe_unused]] static double new_parser(StringView view)
{
    return parse_floating_point_completely<double>(view).release_value();
}

[[maybe_unused]] static float new_parserf(StringView view)
{
    return parse_floating_point_completely<float>(view).release_value();
}

[[maybe_unused]] static double newhex(StringView view)
{
    char const* end = view.characters_without_null_termination() + view.length();
    auto value = parse_first_hexfloat<double>(view.characters_without_null_termination(), end);
    VERIFY(value.error == AK::FloatingPointError::None);
    return value.value;
}

[[maybe_unused]] static float newhexf(StringView view)
{
    char const* end = view.characters_without_null_termination() + view.length();
    auto value = parse_first_hexfloat<float>(view.characters_without_null_termination(), end);
    VERIFY(value.error == AK::FloatingPointError::None);
    return value.value;
}

// #define double_parse_function strtod_wrapper
#define double_parse_function new_parser
#define float_parse_function new_parserf

TEST_CASE(hexfloat)
{

#define does_parse_hex_double_like_cpp(value)                           \
    do {                                                                \
        EXPECT_EQ(static_cast<double>(value), newhex(#value##sv));      \
        EXPECT_EQ(static_cast<double>(-value), newhex("-" #value##sv)); \
    } while (false)

#define does_parse_hex_float_like_cpp(value)                               \
    do {                                                                   \
        EXPECT_EQ(static_cast<float>(value##f), newhexf(#value##sv));      \
        EXPECT_EQ(static_cast<float>(-value##f), newhexf("-" #value##sv)); \
    } while (false)

#define does_parse_hex_float_and_double_like_cpp(value) \
    does_parse_hex_double_like_cpp(value);              \
    does_parse_hex_float_like_cpp(value)

    return;

    does_parse_hex_float_and_double_like_cpp(0x123456789ABCDEFp0);
    does_parse_hex_float_and_double_like_cpp(0x123456789ABCDEFp+0);
    does_parse_hex_float_and_double_like_cpp(0x123456789ABCDEFp-0);
    does_parse_hex_float_and_double_like_cpp(0x123456789ABCDEF.p-0);
    does_parse_hex_float_and_double_like_cpp(0x123456789ABCDEF.123456789ABCDEFp-0);
    does_parse_hex_float_and_double_like_cpp(0x123456789ABCDEF.123456789ABCDEFp-1);
    does_parse_hex_float_and_double_like_cpp(0x123456789ABCDEF.123456789ABCDEFp+1);

    does_parse_hex_float_and_double_like_cpp(0x1.80eafb89ba47cp+52);
    does_parse_hex_float_and_double_like_cpp(0x1.80eafb89ba47c0p+52);
    does_parse_hex_float_and_double_like_cpp(0x1.80eafb89ba47c00p+52);
    does_parse_hex_float_and_double_like_cpp(0x1.80eafb89ba47c000p+52);
    does_parse_hex_float_and_double_like_cpp(0x1.80eafb89ba47c001p+52);
    does_parse_hex_float_and_double_like_cpp(0x1.80eafb89ba47c1p+52);
    does_parse_hex_float_and_double_like_cpp(0x1.80eafb89ba47c10001p+52);
    does_parse_hex_float_and_double_like_cpp(0x1.80eafb89ba47c8p+52);
    does_parse_hex_float_and_double_like_cpp(0x1.80eafb89ba47c8001p+52);
    does_parse_hex_float_and_double_like_cpp(0x1.80eafb89ba47c80000000000000000000000000000000000000000000000000000000001p+52);
    does_parse_hex_float_and_double_like_cpp(0x1.80eafb89ba47c80000000000000000000000000000000000000000000000000000000000p+52);
    does_parse_hex_float_and_double_like_cpp(0x1.80eafb89ba47c7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffp+52);
    does_parse_hex_float_and_double_like_cpp(0x1.80eafb89ba47c9p+52);
    does_parse_hex_float_and_double_like_cpp(0x1.80eafb89ba47c9001p+52);
    does_parse_hex_float_and_double_like_cpp(0x180eafb89ba47c9.001p+52);
    does_parse_hex_float_and_double_like_cpp(0x180eafb89ba47c9.001p-4);

    does_parse_hex_double_like_cpp(0x1.c5e1463479f8ep+218);
    does_parse_hex_double_like_cpp(0x1.c5e1463479f8e8p+218);
    does_parse_hex_double_like_cpp(0x1.c5e1463479f8e80p+218);
    does_parse_hex_double_like_cpp(0x1.c5e1463479f8e800p+218);
    does_parse_hex_double_like_cpp(0x1.c5e1463479f8e8001p+218);

    does_parse_hex_double_like_cpp(0x1.42100a53adbd5p-1024);
    does_parse_hex_double_like_cpp(0x1.d542100a53adbp-1023);
    does_parse_hex_double_like_cpp(0x1.fffffffffffffp-1023);
    does_parse_hex_double_like_cpp(0x1.fffffffffffff9p-1023);
    does_parse_hex_double_like_cpp(0x1.fffffffffffff8p-1023);
    does_parse_hex_double_like_cpp(0x1.fffffffffffff7p-1023);
    does_parse_hex_double_like_cpp(0x1.fffffffffffff800000001p-1023);

    does_parse_hex_double_like_cpp(0x1p-1022);
    does_parse_hex_double_like_cpp(0x2p-1022);
    does_parse_hex_double_like_cpp(0x3p-1022);
    does_parse_hex_double_like_cpp(0x1.0p-1022);
    does_parse_hex_double_like_cpp(0x000000000000000000000000000000000001.0p-1022);
    does_parse_hex_double_like_cpp(0x000000000000000000000000000000000001.000000000000000000p-1022);
}

TEST_CASE(simply_cases)
{

#define does_parse_double_like_cpp(value)                                              \
    do {                                                                               \
        EXPECT_EQ(static_cast<double>(value), double_parse_function(#value##sv));      \
        EXPECT_EQ(-static_cast<double>(value), double_parse_function("-" #value##sv)); \
    } while (false)

#define does_parse_float_like_cpp(value)                                                \
    do {                                                                                \
        float val = float_parse_function(#value##sv);                                   \
        EXPECT_EQ(static_cast<float>(value##f), val);                                   \
        EXPECT_EQ(-static_cast<float>(value##f), float_parse_function("-" #value##sv)); \
    } while (false)

#define does_parse_float_and_double_like_cpp(value) \
    does_parse_double_like_cpp(value);              \
    does_parse_float_like_cpp(value);

    does_parse_double_like_cpp(2.4703282292062327208828439643411068618252990130716238221279284125033775363510437593264991818081799618989828234772285886546332835517796989819938739800539093906315035659515570226392290858392449105184435931802849936536152500319370457678249219365623669863658480757001585769269903706311928279558551332927834338409351978015531246597263579574622766465272827220056374006485499977096599470454020828166226237857393450736339007967761930577506740176324673600968951340535537458516661134223766678604162159680461914467291840300530057530849048765391711386591646239524912623653881879636239373280423891018672348497668235089863388587925628302755995657524455507255189313690836254779186948667994968324049705821028513185451396213837722826145437693412532098591327667236328125001e-324);
    return;

    does_parse_double_like_cpp(2.22507385850720138309e-308);

    does_parse_float_and_double_like_cpp(10090518465521146875.);
    does_parse_float_and_double_like_cpp(10052108125844341766.);
    does_parse_float_and_double_like_cpp(0.);
    constexpr u64 negative_zero = 1ull << 63;
    EXPECT_EQ(0ull, bit_cast<u64>(double_parse_function("0"sv)));
    EXPECT_EQ(negative_zero, bit_cast<u64>(double_parse_function("-0"sv)));
    EXPECT_EQ(negative_zero, bit_cast<u64>(double_parse_function("-0."sv)));
    EXPECT_EQ(negative_zero, bit_cast<u64>(double_parse_function("-0.0"sv)));

    does_parse_double_like_cpp(2.2222222222223e-322);
    does_parse_double_like_cpp(2.2250738585072013e-308);

    does_parse_double_like_cpp(0.54e-85);
    does_parse_double_like_cpp(123);
    does_parse_double_like_cpp(1e10);
    does_parse_float_and_double_like_cpp(001234.0);
    does_parse_float_and_double_like_cpp(123.456);
    does_parse_float_and_double_like_cpp(0.456);
    does_parse_float_and_double_like_cpp(0.456);
    does_parse_float_and_double_like_cpp(0.45689544977495495495197116546843576574949654);
    does_parse_double_like_cpp(0.45689544977495495495197116546843576574949654e81);
    does_parse_double_like_cpp(0.45689544977495495495197116546843576574949654e-81);
    does_parse_float_and_double_like_cpp(7.2057594037927933e+8);
    does_parse_float_and_double_like_cpp(234532.3426362);
    does_parse_double_like_cpp(860228122.6654514319E+90);
    does_parse_double_like_cpp(69294956446009195);
    does_parse_double_like_cpp(69294956446009200);
    does_parse_double_like_cpp(69294956446009199);
    does_parse_double_like_cpp(69294956446009198);
    does_parse_double_like_cpp(69294956446009208);
    does_parse_double_like_cpp(69294956446009204);
    does_parse_double_like_cpp(69294956446009200);
    does_parse_double_like_cpp(69294956446009201);
    does_parse_double_like_cpp(69294956446009202);
    does_parse_double_like_cpp(69294956446009203);
    does_parse_double_like_cpp(69294956446009205);
    does_parse_double_like_cpp(69294956446009206);
    does_parse_float_and_double_like_cpp(69294956446009204.001);
    does_parse_float_and_double_like_cpp(69294956446009204.000);
    does_parse_float_and_double_like_cpp(69294956446009204.0001);
    does_parse_float_and_double_like_cpp(69294956446009204.0000);
    does_parse_float_and_double_like_cpp(69294956446009204.00001);
    does_parse_float_and_double_like_cpp(69294956446009204.000001);
    does_parse_float_and_double_like_cpp(69294956446009204.0000001);
    does_parse_float_and_double_like_cpp(69294956446009204.00000001);
    does_parse_float_and_double_like_cpp(69294956446009204.000000001);
    does_parse_float_and_double_like_cpp(69294956446009204.0000000001);
    does_parse_float_and_double_like_cpp(69294956446009204.00000000001);
    does_parse_float_and_double_like_cpp(69294956446009204.000000000001);
    does_parse_float_and_double_like_cpp(69294956446009204.0000000000001);
    does_parse_float_and_double_like_cpp(69294956446009204.00000000000001);
    does_parse_float_and_double_like_cpp(69294956446009204.000000000000001);
    does_parse_float_and_double_like_cpp(69294956446009204.0000000000000001);
    does_parse_float_and_double_like_cpp(69294956446009204.00000000000000001);
    does_parse_float_and_double_like_cpp(69294956446009204.000000000000000001);
    does_parse_float_and_double_like_cpp(69294956446009204.0000000000000000001);
    does_parse_float_and_double_like_cpp(69294956446009204.00000000000000000001);
    does_parse_float_and_double_like_cpp(69294956446009204.000000000000000000001);
    does_parse_float_and_double_like_cpp(69294956446009204.0000000000000000000001);
    does_parse_double_like_cpp(69294956446009196);
    does_parse_double_like_cpp(69294956446009115);
    does_parse_double_like_cpp(692949564460091155);
    does_parse_double_like_cpp(6929495644600911557);
    does_parse_double_like_cpp(7.0420557077594588669468784357561207962098443483187940792729600000e+59);
    does_parse_double_like_cpp(7.0420557077594588669468784357561207962098443483187940792729600000e+59);
    does_parse_double_like_cpp(1.7339253062092163730578609458683877051596800000000000000000000000e+42);
    does_parse_double_like_cpp(2.0972622234386619214559824785284023792871122537545728000000000000e+52);
    does_parse_double_like_cpp(1.0001803374372191849407179462120053338028379051879898808320000000e+57);
    does_parse_double_like_cpp(1.8607245283054342363818436991534856973992070520151142825984000000e+58);
    does_parse_double_like_cpp(1.9189205311132686907264385602245237137907390376574976000000000000e+52);
    does_parse_double_like_cpp(2.8184483231688951563253238886553506793085187889855201280000000000e+54);
    does_parse_double_like_cpp(1.7664960224650106892054063261344555646357024359107788800000000000e+53);
    does_parse_double_like_cpp(2.1470977154320536489471030463761883783915110400000000000000000000e+45);
    does_parse_double_like_cpp(4.4900312744003159009338275160799498340862630046359789166919680000e+61);
    does_parse_double_like_cpp(2.2222222222223e-322);
    does_parse_double_like_cpp(860228122.6654514319E+90);
    does_parse_double_like_cpp(4.9406564584124653e-324);
    does_parse_double_like_cpp(4.9406564584124654e-324);
    does_parse_double_like_cpp(2.2250738585072009e-308);
    does_parse_double_like_cpp(2.2250738585072014e-308);
    does_parse_double_like_cpp(1.7976931348623157e308);
    does_parse_double_like_cpp(1.7976931348623158e308);
    does_parse_double_like_cpp(0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044501477170144022721148195934182639518696390927032912960468522194496444440421538910330590478162701758282983178260792422137401728773891892910553144148156412434867599762821265346585071045737627442980259622449029037796981144446145705102663115100318287949527959668236039986479250965780342141637013812613333119898765515451440315261253813266652951306000184917766328660755595837392240989947807556594098101021612198814605258742579179000071675999344145086087205681577915435923018910334964869420614052182892431445797605163650903606514140377217442262561590244668525767372446430075513332450079650686719491377688478005309963967709758965844137894433796621993967316936280457084866613206797017728916080020698679408551343728867675409720757232455434770912461317493580281734466552734375);
    does_parse_double_like_cpp(0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022250738585072008890245868760858598876504231122409594654935248025624400092282356951787758888037591552642309780950434312085877387158357291821993020294379224223559819827501242041788969571311791082261043971979604000454897391938079198936081525613113376149842043271751033627391549782731594143828136275113838604094249464942286316695429105080201815926642134996606517803095075913058719846423906068637102005108723282784678843631944515866135041223479014792369585208321597621066375401613736583044193603714778355306682834535634005074073040135602968046375918583163124224521599262546494300836851861719422417646455137135420132217031370496583210154654068035397417906022589503023501937519773030945763173210852507299305089761582519159720757232455434770912461317493580281734466552734375);
    does_parse_float_and_double_like_cpp(9007199254740993.);
    does_parse_float_and_double_like_cpp(9007199254740993.1);
    does_parse_float_and_double_like_cpp(9007199254740993.0000000000000000000000000000000000000000000000000);
    does_parse_float_and_double_like_cpp(9007199254740993.0000000000000000000000000000000000000000000000001);
    does_parse_float_and_double_like_cpp(9007199254740993.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000);
    does_parse_float_and_double_like_cpp(9007199254740993.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000);
    does_parse_float_and_double_like_cpp(9007199254740993.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001);
    does_parse_float_and_double_like_cpp(00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009007199254740993.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000);
    does_parse_float_and_double_like_cpp(00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009007199254740993.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001);

    does_parse_float_and_double_like_cpp(1.17549414062751785924617589866280818433124586473279624003138594271817467598606476997247227700427174568176269531250000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-38);

    does_parse_double_like_cpp(179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.);
    does_parse_double_like_cpp(179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858369.);
    does_parse_double_like_cpp(179769313486231579999999999999999999999999999999999999999917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.);
    does_parse_double_like_cpp(179769313486231580000000000000000000000000000000000000000000000000057260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.);
    does_parse_double_like_cpp(179769313486231580790000000000000000000000000000000000000000000000057260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.);
    does_parse_double_like_cpp(179769313486231580793700000000000000000000000000000000000000000000057260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.);
    does_parse_double_like_cpp(179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.);

    does_parse_float_and_double_like_cpp(7.2057594037927933e+16);
    does_parse_float_and_double_like_cpp(7.3177701707893310e+15);
    does_parse_double_like_cpp(4.2523296908380055e94);
    does_parse_double_like_cpp(4.2523296908380052e94);
    does_parse_float_and_double_like_cpp(6865415254.161212);
    does_parse_double_like_cpp(4.9406564584124654416987984e-324);
    does_parse_double_like_cpp(4.94065645841246544177987491e-324);
    does_parse_double_like_cpp(1.4821969375237396325297063786046641170951794078429742932767570475020265218106262555958995090849079771393896940863371531927799701310678193891963243880323456343789021395709342135835374515035469463110661559081709961921691500191622274606949531619374201918195088454200951461561942223787156967735130799756700603045611186809318747958358147744773659879163696332033824403891299986257959682272412496899735742714436070441803404780657158346504044105794804160581370804321322475109996680534260007162497295808277148680375104180318034518509429259235026831954987743714947574192329127781743623968254334611203409098600941053918033152755376981653597394514673304353113588214501752867512169200796980994429823492617107911270837728302633695687262616047519259154796600341796875e-323);
    does_parse_double_like_cpp(0.14821969375237396325297063786046641170951794078429742932767570475020265218106262555958995090849079771393896940863371531927799701310678193891963243880323456343789021395709342135835374515035469463110661559081709961921691500191622274606949531619374201918195088454200951461561942223787156967735130799756700603045611186809318747958358147744773659879163696332033824403891299986257959682272412496899735742714436070441803404780657158346504044105794804160581370804321322475109996680534260007162497295808277148680375104180318034518509429259235026831954987743714947574192329127781743623968254334611203409098600941053918033152755376981653597394514673304353113588214501752867512169200796980994429823492617107911270837728302633695687262616047519259154796600341796875e-322);
    does_parse_double_like_cpp(0000000000000000000000000000.14821969375237396325297063786046641170951794078429742932767570475020265218106262555958995090849079771393896940863371531927799701310678193891963243880323456343789021395709342135835374515035469463110661559081709961921691500191622274606949531619374201918195088454200951461561942223787156967735130799756700603045611186809318747958358147744773659879163696332033824403891299986257959682272412496899735742714436070441803404780657158346504044105794804160581370804321322475109996680534260007162497295808277148680375104180318034518509429259235026831954987743714947574192329127781743623968254334611203409098600941053918033152755376981653597394514673304353113588214501752867512169200796980994429823492617107911270837728302633695687262616047519259154796600341796875e-322);
    does_parse_double_like_cpp(0000000000000000000000000000.000000000014821969375237396325297063786046641170951794078429742932767570475020265218106262555958995090849079771393896940863371531927799701310678193891963243880323456343789021395709342135835374515035469463110661559081709961921691500191622274606949531619374201918195088454200951461561942223787156967735130799756700603045611186809318747958358147744773659879163696332033824403891299986257959682272412496899735742714436070441803404780657158346504044105794804160581370804321322475109996680534260007162497295808277148680375104180318034518509429259235026831954987743714947574192329127781743623968254334611203409098600941053918033152755376981653597394514673304353113588214501752867512169200796980994429823492617107911270837728302633695687262616047519259154796600341796875e-312);
    does_parse_double_like_cpp(6.422853395936205074295394307286877840745777433986221937532613872508781594512713774248897872701267900937355341040794330502046537234627217353184072348140164415641909271474048258861995623182036767347953342268740983499399650083036318996344797035062154164551204996820412300010174963641101352685223346561236927986431514284038124115288530689401919280970935077214657241686229994045115862318045415323218821842922297191448142071618101950151752445844415136251927e-323);
    does_parse_double_like_cpp(6.522853395936205074295394307286877840745777433986221937532613872508781594512713774248897872701267900937355341040794330502046537234627217353184072348140164415641909271474048258861995623182036767347953342268740983499399650083036318996344797035062154164551204996820412300010174963641101352685223346561236927986431514284038124115288530689401919280970935077214657241686229994045115862318045415323218821842922297191448142071618101950151752445844415136251927e-323);
    does_parse_double_like_cpp(7.522853395936205074295394307286877840745777433986221937532613872508781594512713774248897872701267900937355341040794330502046537234627217353184072348140164415641909271474048258861995623182036767347953342268740983499399650083036318996344797035062154164551204996820412300010174963641101352685223346561236927986431514284038124115288530689401919280970935077214657241686229994045115862318045415323218821842922297191448142071618101950151752445844415136251927e-323);
    does_parse_double_like_cpp(7.5228498395936205074295394307286877840745777433986221937532613872508781594512713774248897872701267900937355341040794330502046537234627217353184072348140164415641909271474048258861995623182036767347953342268740983499399650083036318996344797035062154164551204996820412300010174963641101352685223346561236927986431514284038124115288530689401919280970935077214657241686229994045115862318045415323218821842922297191448142071618101950151752445844415136251927e-323);
    does_parse_double_like_cpp(0.5228498395936205074295394307286877840745777433986221937532613872508781594512713774248897872701267900937355341040794330502046537234627217353184072348140164415641909271474048258861995623182036767347953342268740983499399650083036318996344797035062154164551204996820412300010174963641101352685223346561236927986431514284038124115288530689401919280970935077214657241686229994045115862318045415323218821842922297191448142071618101950151752445844415136251927e-323);

    // actual interesting (non 19+ digit) failures from current strtod'
    does_parse_float_and_double_like_cpp(89255e-22);
    does_parse_double_like_cpp(1e126);
    does_parse_double_like_cpp(1e210);
    does_parse_float_and_double_like_cpp(358416272e-33);

    does_parse_float_and_double_like_cpp(89255e-22);
    does_parse_float_and_double_like_cpp(8925.5e-21);
    does_parse_float_and_double_like_cpp(8.9255e-18);
    does_parse_float_and_double_like_cpp(8925500e-24);
    does_parse_float_and_double_like_cpp(89256e-22);
    does_parse_float_and_double_like_cpp(89254e-22);

    does_parse_float_and_double_like_cpp(3.518437208883201171875e13);
    does_parse_float_and_double_like_cpp(62.5364939768271845828);
    does_parse_float_and_double_like_cpp(8.10109172351e-10);
    does_parse_float_and_double_like_cpp(1.50000000000000011102230246251565404236316680908203125);
    does_parse_float_and_double_like_cpp(9007199254740991.4999999999999999999999999999999995);

    does_parse_double_like_cpp(7.4109846876186981626485318930233205854758970392148714663837852375101326090531312779794975454245398856969484704316857659638998506553390969459816219401617281718945106978546710679176872575177347315553307795408549809608457500958111373034747658096871009590975442271004757307809711118935784838675653998783503015228055934046593739791790738723868299395818481660169122019456499931289798411362062484498678713572180352209017023903285791732520220528974020802906854021606612375549983402671300035812486479041385743401875520901590172592547146296175134159774938718574737870961645638908718119841271673056017045493004705269590165763776884908267986972573366521765567941072508764337560846003984904972149117463085539556354188641513168478436313080237596295773983001708984375001e-324);
    does_parse_double_like_cpp(7.4109846876186981626485318930233205854758970392148714663837852375101326090531312779794975454245398856969484704316857659638998506553390969459816219401617281718945106978546710679176872575177347315553307795408549809608457500958111373034747658096871009590975442271004757307809711118935784838675653998783503015228055934046593739791790738723868299395818481660169122019456499931289798411362062484498678713572180352209017023903285791732520220528974020802906854021606612375549983402671300035812486479041385743401875520901590172592547146296175134159774938718574737870961645638908718119841271673056017045493004705269590165763776884908267986972573366521765567941072508764337560846003984904972149117463085539556354188641513168478436313080237596295773983001708984375e-324);
    does_parse_double_like_cpp(7.4109846876186981626485318930233205854758970392148714663837852375101326090531312779794975454245398856969484704316857659638998506553390969459816219401617281718945106978546710679176872575177347315553307795408549809608457500958111373034747658096871009590975442271004757307809711118935784838675653998783503015228055934046593739791790738723868299395818481660169122019456499931289798411362062484498678713572180352209017023903285791732520220528974020802906854021606612375549983402671300035812486479041385743401875520901590172592547146296175134159774938718574737870961645638908718119841271673056017045493004705269590165763776884908267986972573366521765567941072508764337560846003984904972149117463085539556354188641513168478436313080237596295773983001708984374999e-324);
    does_parse_double_like_cpp(2.4703282292062327208828439643411068618252990130716238221279284125033775363510437593264991818081799618989828234772285886546332835517796989819938739800539093906315035659515570226392290858392449105184435931802849936536152500319370457678249219365623669863658480757001585769269903706311928279558551332927834338409351978015531246597263579574622766465272827220056374006485499977096599470454020828166226237857393450736339007967761930577506740176324673600968951340535537458516661134223766678604162159680461914467291840300530057530849048765391711386591646239524912623653881879636239373280423891018672348497668235089863388587925628302755995657524455507255189313690836254779186948667994968324049705821028513185451396213837722826145437693412532098591327667236328125001e-324);

    does_parse_double_like_cpp(2.22507385850720138309e-308);

    does_parse_double_like_cpp(1e55);

    does_parse_double_like_cpp(1e300);
    does_parse_double_like_cpp(1e301);
    does_parse_double_like_cpp(1e302);
    does_parse_double_like_cpp(1e303);
    does_parse_double_like_cpp(1e304);
    does_parse_double_like_cpp(1e305);
    does_parse_double_like_cpp(1e299);

    does_parse_float_and_double_like_cpp(3.4028235E38);
    does_parse_float_and_double_like_cpp(4e31);
    does_parse_float_and_double_like_cpp(9007199254740991.);

    does_parse_float_and_double_like_cpp(7.038531E-26);
    does_parse_float_and_double_like_cpp(46116538.);
    does_parse_float_and_double_like_cpp(20040229.);
    does_parse_float_and_double_like_cpp(9771305410219737088.);
    does_parse_float_and_double_like_cpp(1146.);

    does_parse_float_and_double_like_cpp(7.0064923216240854e-46);
    does_parse_float_and_double_like_cpp(1.1877630352973938);
    does_parse_float_and_double_like_cpp(2.1665680640000002384185791015625e9);
    does_parse_float_and_double_like_cpp(8.589934335999999523162841796875e+09);
    does_parse_float_and_double_like_cpp(0.09289376810193062);

#define does_parse_intish_value_like_cpp(value)                                           \
    do {                                                                                  \
        EXPECT_EQ(static_cast<double>(value##.), double_parse_function(#value##sv));      \
        EXPECT_EQ(-static_cast<double>(value##.), double_parse_function("-" #value##sv)); \
    } while (false)

    does_parse_intish_value_like_cpp(0);
    does_parse_intish_value_like_cpp(1);
    does_parse_intish_value_like_cpp(2);
    does_parse_intish_value_like_cpp(20);
    does_parse_intish_value_like_cpp(200);
    does_parse_intish_value_like_cpp(234);
    does_parse_intish_value_like_cpp(8419841);

    EXPECT_EQ(67677557565221539913., double_parse_function("67677557565221539913"sv));
    EXPECT_EQ(0., double_parse_function("2.4703282292062327208828439643411068618252990130716238221279284125033775363510437593264991818081799618989828234772285886546332835517796989819938739800539093906315035659515570226392290858392449105184435931802849936536152500319370457678249219365623669863658480757001585769269903706311928279558551332927834338409351978015531246597263579574622766465272827220056374006485499977096599470454020828166226237857393450736339007967761930577506740176324673600968951340535537458516661134223766678604162159680461914467291840300530057530849048765391711386591646239524912623653881879636239373280423891018672348497668235089863388587925628302755995657524455507255189313690836254779186948667994968324049705821028513185451396213837722826145437693412532098591327667236328125e-324"sv));
    EXPECT_EQ(0., double_parse_function("2.4703282292062327208828439643411068618252990130716238221279284125033775363510437593264991818081799618989828234772285886546332835517796989819938739800539093906315035659515570226392290858392449105184435931802849936536152500319370457678249219365623669863658480757001585769269903706311928279558551332927834338409351978015531246597263579574622766465272827220056374006485499977096599470454020828166226237857393450736339007967761930577506740176324673600968951340535537458516661134223766678604162159680461914467291840300530057530849048765391711386591646239524912623653881879636239373280423891018672348497668235089863388587925628302755995657524455507255189313690836254779186948667994968324049705821028513185451396213837722826145437693412532098591327667236328124999e-324"sv));

#define gives_equal_to(expected_val, str) \
    EXPECT_EQ(expected_val, double_parse_function(str##sv));

    gives_equal_to(0.0, "1e-324");

#define gives_infinity(str)                                                                  \
    EXPECT_EQ(__builtin_huge_val(), double_parse_function(str##sv));                         \
    EXPECT_EQ(__builtin_huge_val(), double_parse_function("+" str##sv));                     \
    EXPECT_EQ(-__builtin_huge_val(), double_parse_function("-" str##sv));                    \
    EXPECT_EQ(static_cast<float>(__builtin_huge_valf()), float_parse_function(str##sv));     \
    EXPECT_EQ(static_cast<float>(__builtin_huge_valf()), float_parse_function("+" str##sv)); \
    EXPECT_EQ(static_cast<float>(-__builtin_huge_valf()), float_parse_function("-" str##sv))

    gives_infinity("123.456e789");
    gives_infinity("123456.456789e789");
    gives_infinity("1438456663141390273526118207642235581183227845246331231162636653790368152091394196930365828634687637948157940776599182791387527135353034738357134110310609455693900824193549772792016543182680519740580354365467985440183598701312257624545562331397018329928613196125590274187720073914818062530830316533158098624984118889298281371812288789537310599037529113415438738954894752124724983067241108764488346454376699018673078404751121414804937224240805993123816932326223683090770561597570457793932985826162604255884529134126396282202126526253389383421806727954588525596114379801269094096329805054803089299736996870951258573010877404407451953846698609198213926882692078557033228265259305481198526059813164469187586693257335779522020407645498684263339921905227556616698129967412891282231685504660671277927198290009824680186319750978665734576683784255802269708917361719466043175201158849097881370477111850171579869056016061666173029059588433776015644439705050377554277696143928278093453792803846252715966016733222646442382892123940052441346822429721593884378212558701004356924243030059517489346646577724622498919752597382095222500311124181823512251071356181769376577651390028297796156208815375089159128394945710515861334486267101797497111125909272505194792870889617179758703442608016143343262159998149700606597792535574457560429226974273443630323818747730771316763398572110874959981923732463076884528677392654150010269822239401993427482376513231389212353583573566376915572650916866553612366187378959554983566712767093372906030188976220169058025354973622211666504549316958271880975697143546564469806791358707318873075708383345004090151974068325838177531266954177406661392229801349994695941509935655355652985723782153570084089560139142231.738475042362596875449154552392299548947138162081694168675340677843807613129780449323363759027012972466987370921816813162658754726545121090545507240267000456594786540949605260722461937870630634874991729398208026467698131898691830012167897399682179601734569071423681e-733");
    gives_infinity("3e182947912346759234");
    gives_infinity("3e70000000000000");
    gives_infinity("3e70000000000");
    gives_infinity("3e70000000");
    gives_infinity("1e681");
    gives_infinity("7e312");
}
